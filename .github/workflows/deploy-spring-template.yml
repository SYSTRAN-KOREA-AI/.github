name: Spring Deployment Template (Final)

on:
  workflow_call:
    inputs:
      service_name:
        description: "docker-compose.yml 안의 service 이름 (예: e2e-test)"
        required: true
        type: string
      target_host:
        required: true
        type: string
      target_port:
        required: true
        type: string
      target_user:
        required: true
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
      TARGET_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2) systran prefix 제거 (host / port / user)
      - name: Normalize host
        id: host
        run: |
          RAW="${{ inputs.target_host }}"
          HOST="${RAW#systran-}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"

      - name: Normalize port
        id: port
        run: |
          RAW="${{ inputs.target_port }}"
          PORT="${RAW#systran-}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Normalize user
        id: user
        run: |
          RAW="${{ inputs.target_user }}"
          USER="${RAW#systran-}"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      # 3) SSH 키 준비 (Base64 -> 파일)
      - name: Prepare SSH key
        run: |
          echo "${{ secrets.TARGET_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      # 4) DockerHub 로그인
      - name: DockerHub login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 5) 이미지 빌드 & 푸시
      - name: Build image
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.service_name }}:latest"
          echo "[BUILD] $IMAGE"
          docker build -t "$IMAGE" .

      - name: Push image
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.service_name }}:latest"
          echo "[PUSH] $IMAGE"
          docker push "$IMAGE"

      # 6) Docker Hub 쪽 오래된 태그 정리 (원하면 끌 수도 있게 별도 step)
      #    현재 가정: latest 만 쓰거나, 과거 태그 필요 없다는 전제.
      - name: Cleanup old Docker Hub tags (keep latest only)
        run: |
          REPO="${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.service_name }}"
          echo "[CLEANUP] Docker Hub repo: $REPO"

          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST \
            -d "{\"username\": \"${{ secrets.DOCKERHUB_USERNAME }}\", \"password\": \"${{ secrets.DOCKERHUB_TOKEN }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)

          TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            "https://hub.docker.com/v2/repositories/$REPO/tags/?page_size=100" \
            | jq -r '.results[].name')

          for TAG in $TAGS; do
            if [ "$TAG" != "latest" ]; then
              echo "[CLEANUP] delete $REPO:$TAG"
              curl -s -X DELETE \
                -H "Authorization: JWT $TOKEN" \
                "https://hub.docker.com/v2/repositories/$REPO/tags/$TAG/" >/dev/null
            fi
          done

      # 7) 서버 접속해서 해당 service 만 부분 배포
      - name: Deploy on server (partial update)
        run: |
          ssh -i private_key -p "${{ steps.port.outputs.port }}" \
            "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}" << 'EOF'
            set -e

            echo "[DEPLOY] move to /opt/business_meeting"
            cd /opt/business_meeting

            echo "[DEPLOY] docker compose pull ${{ inputs.service_name }}"
            docker compose pull ${{ inputs.service_name }}

            echo "[DEPLOY] docker compose up -d ${{ inputs.service_name }}"
            docker compose up -d ${{ inputs.service_name }}

            echo "[CLEANUP] remove unused docker images on server"
            docker image prune -af || true
            EOF
