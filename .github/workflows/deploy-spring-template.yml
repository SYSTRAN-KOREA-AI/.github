name: Spring Deployment Template (Optimized + Prefix Remove)

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
    secrets:
      target_host:
        required: true
      target_port:
        required: true
      target_user:
        required: true
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
      TARGET_KEY:
        required: true
      APP_YML:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ############################################
      # ðŸ”¥ systran- prefix ì œê±° (ë°˜ë“œì‹œ í•„ìš”)
      ############################################

      - name: Normalize host
        id: host
        run: |
          RAW="${{ secrets.target_host }}"
          HOST="${RAW#systran-}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"

      - name: Normalize port
        id: port
        run: |
          RAW="${{ secrets.target_port }}"
          PORT="${RAW#systran-}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Normalize user
        id: user
        run: |
          RAW="${{ secrets.target_user }}"
          USER="${RAW#systran-}"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      ############################################
      # ðŸ”¥ Gradle ìµœì í™” ë¹Œë“œ (jar ìƒì„±)
      ############################################

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            **/.gradle/config-cache
          key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-cache-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Create application.yml
        run: |
          echo "${{ secrets.APP_YML }}" > ./src/main/resources/application.yml

      - name: Build jar (bootJar + config cache)
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar --parallel --daemon --configuration-cache
        env:
          CI: true

      ############################################
      # ðŸ”¥ Docker Build & Push
      ############################################

      - name: DockerHub login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.service_name }}:latest"
          echo "[BUILD] $IMAGE"
          docker build -t "$IMAGE" .

      - name: Push image
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.service_name }}:latest"
          echo "[PUSH] $IMAGE"
          docker push "$IMAGE"

      - name: Cleanup old Docker Hub tags (keep only latest)
        run: |
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.service_name }}/tags?page_size=100" \
            | jq -r '.results[].name')

          for TAG in $TAGS; do
            if [ "$TAG" != "latest" ]; then
              echo "Deleting tag: $TAG"
              TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "${{ secrets.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' https://hub.docker.com/v2/users/login/ | jq -r .token)
              curl -s -X DELETE \
                -H "Authorization: JWT ${TOKEN}" \
                "https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.service_name }}/tags/$TAG/"
            fi
          done

      ############################################
      # ðŸ”¥ SSHë¡œ ì„œë²„ ë¶€ë¶„ ë°°í¬
      ############################################

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.TARGET_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key -p "${{ steps.port.outputs.port }}" \
            "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}" '
            set -e
            cd /opt/business_meeting

            echo "[DEPLOY] docker compose pull ${{ inputs.service_name }}"
            docker compose pull ${{ inputs.service_name }}

            echo "[DEPLOY] docker compose up -d ${{ inputs.service_name }}"
            docker compose up -d ${{ inputs.service_name }}

            echo "[CLEANUP] remove unused images"
            docker image prune -af || true
            '