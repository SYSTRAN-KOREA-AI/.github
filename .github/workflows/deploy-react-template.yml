on:
  workflow_call:
    inputs:
      SERVICE_NAME:
        required: true
        type: string
      BASE_REMOTE_PATH:
        required: true
        type: string
      PROFILE: # New input for the selected profile (dev/stage/prod)
        required: true
        type: string
    secrets:
      PREFIX_HOST:
        required: true
      PREFIX_PORT:
        required: true
      PREFIX_USER:
        required: true
      BASE64_KEY:
        required: true
      ENV_DEV_FILE: # New secret for dev .env config
        required: true
      ENV_STAGE_FILE: # New secret for stage .env config
        required: true
      ENV_PROD_FILE: # New secret for prod .env config
        required: true
      SLACK_WEBHOOK_URL:
        required: true

jobs:
  build_app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: SYSTRAN-KOREA-AI/${{ inputs.SERVICE_NAME }}
          path: ${{ inputs.SERVICE_NAME }}
          fetch-depth: 0

      - name: Set up Node.js
        id: node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ steps.node.outputs.version }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ steps.node.outputs.version }}-npm-

      - name: Create profile-specific .env files
        run: |
          echo "${{ secrets.ENV_DEV_FILE }}" > .env.dev
          echo "${{ secrets.ENV_STAGE_FILE }}" > .env.stage
          echo "${{ secrets.ENV_PROD_FILE }}" > .env.prod
        working-directory: ${{ inputs.SERVICE_NAME }}

      - name: Install dependencies and build
        run: |
          npm install
          # Run the build script corresponding to the selected profile
          npm run build:${{ inputs.PROFILE }}
        working-directory: ${{ inputs.SERVICE_NAME }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-artifact
          path: ${{ inputs.SERVICE_NAME }}/dist

  deploy_app:
    runs-on: ubuntu-latest
    needs: build_app
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-artifact
          path: dist-download

      # prefix 제거
      - name: Normalize host
        id: host
        run: |
          RAW="${{ secrets.PREFIX_HOST }}"
          HOST="${RAW#systran-}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"

      - name: Normalize port
        id: port
        run: |
          RAW="${{ secrets.PREFIX_PORT }}"
          PORT="${RAW#systran-}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Normalize user
        id: user
        run: |
          RAW="${{ secrets.PREFIX_USER }}"
          USER="${RAW#systran-}"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy to server and restart Nginx
        run: |
          echo "Deploying dist folder via rsync..."
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no -i private_key -p ${{ steps.port.outputs.port }}" \
            ./dist-download/ "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}:${{ inputs.BASE_REMOTE_PATH }}/nginx/dist/"

          echo "Restarting Nginx container..."
          ssh -o StrictHostKeyChecking=no -i private_key -p "${{ steps.port.outputs.port }}" \
            "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}" '
            set -e
            cd ${{ inputs.BASE_REMOTE_PATH }}
            docker compose restart nginx
            echo "Nginx container restarted successfully."
            '

  notify_slack:
    runs-on: ubuntu-latest
    needs: [deploy_app]
    if: always() # Job always runs, logic inside determines if a notification is sent
    steps:
      - name: Checkout .github repo to get user map
        uses: actions/checkout@v4
        with:
          repository: SYSTRAN-KOREA-AI/.github
          path: '.github-meta'

      - name: Read notification policy from map
        id: policy
        run: |
          USER_MAP_FILE=".github-meta/user-map.json"
          SERVICE_NAME="${{ inputs.SERVICE_NAME }}"
          
          # 1. Check if notifications are enabled for this service. Default to false if not specified.
          IS_ENABLED=$(jq -r ".projects[\"$SERVICE_NAME\"].notify // \"false\"" $USER_MAP_FILE)
          echo "is_enabled=$IS_ENABLED" >> "$GITHUB_OUTPUT"
          
          # 2. Find project owner's GitHub username from the service name
          OWNER_USERNAME=$(jq -r ".projects[\"$SERVICE_NAME\"].owner // \"null\"" $USER_MAP_FILE)
          
          # 3. Determine which GitHub username to use (owner, or actor if no owner)
          if [ "$OWNER_USERNAME" != "null" ]; then
            TARGET_USERNAME=$OWNER_USERNAME
          else
            TARGET_USERNAME="${{ github.actor }}"
          fi
          echo "target_user=$TARGET_USERNAME" >> "$GITHUB_OUTPUT"

      - name: Get Slack User ID for target
        id: slack-user
        if: steps.policy.outputs.is_enabled == 'true'
        run: |
          USER_MAP_FILE=".github-meta/user-map.json"
          TARGET_USERNAME="${{ steps.policy.outputs.target_user }}"
          
          # Get the Slack ID for the target username (fallback to 'channel')
          SLACK_USER_ID=$(jq -r ".users[\"$TARGET_USERNAME\"] // \"channel\"" $USER_MAP_FILE)
          
          echo "SLACK_MENTION=<@$SLACK_USER_ID>" >> "$GITHUB_OUTPUT"

      - name: Send Slack Notification
        if: steps.policy.outputs.is_enabled == 'true'
        uses: act10ns/slack@v2
        with:
          status: ${{ needs.deploy_app.result }}
          message: |
            ${{ steps.slack-user.outputs.SLACK_MENTION }} *${{ inputs.SERVICE_NAME }}* 서비스의 *${{ inputs.PROFILE }}* 환경 배포가 종료되었습니다.
            • *결과:* `${{ needs.deploy_app.result }}`
            • *실행자:* `${{ github.actor }}`
            • <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|워크플로우 실행 로그 보기>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
